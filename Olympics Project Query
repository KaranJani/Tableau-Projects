--CREATING DUPLICATE TABLE
SELECT * INTO ATHELETES_D FROM ATHELETES


--JUST VERIFYING AUTHENTICITY OF DATA (COMPARING WITH WIKIPEDIA)
--CHECKING TOP PERFORMERS
SELECT TOP 10 NAME,SUM(medal_count) m_count
	FROM ATHELETES_D
	where Season='Summer'
	GROUP BY Name
	order by m_count desc
-->DATA SEEMS FINE



--GOING THROUGH VARIOUS COUNTRIES AND TEAMS WHO PARTICIPATED BEFORE 1950
--(BECAUSE MAJOR COUNTRIES HAD PARTITIONED BEFORE 1950)
--(LEADING TO NAME/CODE CHANGES)
SELECT DISTINCT NOC,Team 
	FROM ATHELETES_D
	WHERE Year<1950


--TOTAL NO.OF MEDALS AWARDED IN OLYMPICS
SELECT SUM(medal_count) FROM ATHELETES_D


--CALCULATING TOTAL NO.OF MEDALS PER NOC WHERE COUNTRY IS NULL AFTER JOINING WITH (COUNTRY_CODE TABLE)
SELECT SUM(medal_count) Q,A.NOC
	FROM ATHELETES_D A
	LEFT JOIN COUNTRY_CODE C
	ON A.NOC=C.COUNTRY_CODE
	WHERE C.[COUNTRY NAME] IS NULL
	GROUP BY A.NOC
	ORDER BY Q DESC
-->>MAJOR COUNTRIES/TERITORIES/UNIONS WHICH GOT PARTITIONED 
-->>HAVE NOC==>YUG,TCH,URS,EUN

-->>NOT CONSIDERING DATA OF COUNTRIES/TERITORIES/UNIONS WHICH GOT PARTIONED

--DELETING DATA HAVING NOC=YUG,TCH,URS,EUN 
DELETE
	FROM ATHELETES_D
	WHERE   NOC='YUG'
			OR NOC='TCH'
			OR NOC='URS'
			OR NOC='EUN'
-->>13536 RECORDS DELETED AND 3660 MEDALS IN TOTAL


--CHECKING TOTAL NO.OF MEDALS WON BY ALL NOC COMBINED HAVING COUNTRY AS NULL AFTER JOINING WITH (NOC_CODES TABLE)
SELECT SUM(A.medal_count) S,A.NOC NOC
	FROM ATHELETES_D A
	LEFT JOIN NOC_CODES N
	ON A.NOC=N.NOC
	WHERE N.NOC IS NULL
	GROUP BY A.NOC
	ORDER BY S DESC
-->>TOTAL MEDALS WON BY ALL NOC COMBINED HAVING COUNTRY AS NULL IS <100



--DELETING RECORDS HAVING COUNTRIES AS NULLS (AS MEDAL COUNT IS > 0.003% OF TOTAL MEDALS AWARDED)
DELETE
	FROM ATHELETES_D
	WHERE NOC IN 
			(
			SELECT A.NOC
			FROM ATHELETES_D A
			LEFT JOIN NOC_CODES N
			ON A.NOC=N.NOC
			WHERE N.NOC IS NULL
			GROUP BY A.NOC
			)


--RECHECKING IF THERE ARE STILL ANY FLAWS LEFT
SELECT A.NOC,MAX(N.COUNTRY_NAME) COUNTRYNAME
	FROM ATHELETES_D A
	LEFT JOIN NOC_CODES N
	ON A.NOC=N.NOC
	GROUP BY A.NOC


--CREATING FINAL TABLE
SELECT A.ID,A.Name,N.COUNTRY_NAME,A.Year,A.Medal,A.medal_count,A.medal_bronze,A.medal_silver,
	A.medal_gold,A.Season,A.Sport,A.Event
	INTO FINAL
	FROM ATHELETES_D A
	LEFT JOIN NOC_CODES N
	ON A.NOC=N.NOC
